<div id="correct-hero-modal" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog text-dark" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Correct hero detection</h5>
            </div>
            <div class="modal-body">
                <select id="correct-hero-name" class="form-control">
                {% for heroId, heroName in gui.gameData.heroes.name[gui.config.language] %}
                    <option value="{{ heroId }}">{{ heroName }}</option>
                {% endfor %}
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="close-modal-btn" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="save-modal-btn">Save changes</button>
            </div>
        </div>
    </div>
</div>
<script>
jQuery(function() {

    let buttonHandlerAttached = false;

    let initCorrectionElements = function(element) {
        // Manually correct failed detections
        jQuery(element).find("[data-failed]").on("click", function () {
            let heroNameFailed = jQuery(this).attr("data-failed");
            let clickedElement = this;
            
            // Attach button handlers only once
            if (!buttonHandlerAttached) {
                buttonHandlerAttached = true;
                
                // Save button handler
                jQuery("#save-modal-btn").on("click", function (e) {
                    e.preventDefault();
                    let selectedHeroId = jQuery("#correct-hero-modal select").val();
                    
                    // Check which type of correction to save
                    let failedType = jQuery(clickedElement).attr("data-failed");
                    if (failedType === "BAN") {
                        gui.saveHeroBanImage(selectedHeroId, null);
                    } else {
                        gui.saveCorrection(failedType, selectedHeroId);
                    }
                    
                    // Hide modal
                    jQuery("#correct-hero-modal").modal("hide");
                });
                
                // Close button handler
                jQuery("#close-modal-btn").on("click", function (e) {
                    jQuery("#correct-hero-modal").modal("hide");
                });
                
                // X button handler
                jQuery("#correct-hero-modal .close").on("click", function (e) {
                    jQuery("#correct-hero-modal").modal("hide");
                });
            }
            
            // Show the modal
            jQuery("#correct-hero-modal").modal("show");
            
            // Prevent re-rendering while the modal is open
            gui.setModalActive(true);
            
            // Update clickedElement for button handler
            window.currentCorrectionElement = clickedElement;
        });
    };

    // Handle modal close (for close button, X button, etc.)
    jQuery("#correct-hero-modal").on("hidden.bs.modal", function () {
        gui.setModalActive(false);
    });

    jQuery(document).on("player.init ban.init", function(event, element) {
        initCorrectionElements(element);
    });
    initCorrectionElements(document);

});
</script>

});
</script>

});
</script>
